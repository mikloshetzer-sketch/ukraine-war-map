name: Update DeepState GeoJSON (daily) + dates index

on:
  workflow_dispatch:
  schedule:
    - cron: "15 3 * * *" # naponta 03:15 UTC

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Prepare folders
        run: |
          mkdir -p data
          mkdir -p scripts

      # EZ A RÉSZ NÁLAD MÁR VALÓSZÍNŰ MEGVAN:
      # - listázás + latest letöltése + deepstate_latest.geojson frissítése + deepstate_dates.json frissítése
      # Ha nálad más a logika, ezt a stepet hagyd meg a sajátodra, csak a commit stepet cseréld!
      - name: Build dates index + download latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          API="https://api.github.com/repos/cyterat/deepstate-map-data/contents/data"
          echo "Listing: $API"

          curl -sS -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "$API" > listing.json

          # fájlnevek kigyűjtése
          jq -r '.[].name' listing.json | grep -E '^deepstatemap_data_[0-9]{8}\.geojson$' | sort > names.txt

          LATEST="$(tail -n 1 names.txt)"
          echo "Latest: $LATEST"

          # letöltés raw URL-ről
          RAW_URL="https://raw.githubusercontent.com/cyterat/deepstate-map-data/main/data/$LATEST"
          echo "Downloading: $RAW_URL"

          curl -sS "$RAW_URL" -o "data/deepstate_latest.geojson"

          # deepstate_dates.json generálása (URL-kel!)
          python3 - <<'PY'
import json, re
from pathlib import Path

names = Path("names.txt").read_text(encoding="utf-8").splitlines()
out = []
for n in names:
    m = re.search(r"deepstatemap_data_(\d{8})\.geojson", n)
    if not m: 
        continue
    d = m.group(1)
    out.append({
        "date": f"{d[0:4]}-{d[4:6]}-{d[6:8]}",
        "name": n,
        "raw": f"https://raw.githubusercontent.com/cyterat/deepstate-map-data/main/data/{n}"
    })
Path("data/deepstate_dates.json").write_text(json.dumps(out, ensure_ascii=False, indent=2), encoding="utf-8")
print("Wrote data/deepstate_dates.json", "items:", len(out))
PY

      # ✅ EZ A LÉNYEG: mindent hozzáadunk, nem csak pár fájlt
      - name: Commit & push if changed
        run: |
          set -e

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # FONTOS: untracked fájlokat is addol!
          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update DeepState GeoJSON + dates index"
          git push
