name: Update DeepState GeoJSON (daily)

on:
  workflow_dispatch:
  schedule:
    - cron: "25 3 * * *"  # 03:25 UTC

permissions:
  contents: write

concurrency:
  group: update-deepstate
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (your repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download upstream ZIP (cyterat/deepstate-map-data)
        run: |
          set -euo pipefail
          rm -rf /tmp/deepstate_upstream
          mkdir -p /tmp/deepstate_upstream

          URL_MAIN="https://codeload.github.com/cyterat/deepstate-map-data/zip/refs/heads/main"
          URL_MASTER="https://codeload.github.com/cyterat/deepstate-map-data/zip/refs/heads/master"

          echo "Downloading (try main): $URL_MAIN"
          if curl -L --fail "$URL_MAIN" -o /tmp/deepstate_upstream/up.zip; then
            echo "Downloaded from main"
          else
            echo "main failed, trying master: $URL_MASTER"
            curl -L --fail "$URL_MASTER" -o /tmp/deepstate_upstream/up.zip
            echo "Downloaded from master"
          fi

          cd /tmp/deepstate_upstream
          unzip -q up.zip
          ls -la

      - name: Copy latest + build deepstate_dates.json
        run: |
          set -euo pipefail
          mkdir -p data

          python3 - <<'PY'
          import json, re, shutil
          from datetime import datetime
          from pathlib import Path

          base = Path("/tmp/deepstate_upstream")
          # zip kibontás után tipikusan: deepstate-map-data-main vagy deepstate-map-data-master
          cand = list(base.glob("deepstate-map-data-*/data"))
          if not cand:
              raise SystemExit("Upstream extracted folder not found: deepstate-map-data-*/data")
          upstream_data = cand[0]

          out_dir = Path("data")
          pat = re.compile(r"deepstatemap_data_(\d{8})\.geojson$", re.IGNORECASE)

          candidates = []
          for p in upstream_data.glob("deepstatemap_data_*.geojson"):
              m = pat.search(p.name)
              if not m:
                  continue
              ymd = m.group(1)
              try:
                  d = datetime.strptime(ymd, "%Y%m%d").date()
              except Exception:
                  continue
              candidates.append((d, p))

          if not candidates:
              raise SystemExit("No candidates found in upstream (deepstatemap_data_*.geojson).")

          candidates.sort(key=lambda x: x[0])
          latest_date, latest_path = candidates[-1]

          # 1) legfrissebb fájl átmásolása a repódba
          target_latest = out_dir / latest_path.name
          shutil.copyfile(latest_path, target_latest)

          # 2) deepstate_latest.geojson (könnyű hivatkozás)
          shutil.copyfile(target_latest, out_dir / "deepstate_latest.geojson")

          # 3) deepstate_dates.json a HELYI data mappából (timeline)
          local_files = sorted(out_dir.glob("deepstatemap_data_*.geojson"))
          out = []
          for p in local_files:
              m = pat.search(p.name)
              if not m:
                  continue
              ymd = m.group(1)
              d = datetime.strptime(ymd, "%Y%m%d").date()
              out.append({
                  "date": d.isoformat(),
                  "name": p.name,
                  "raw": f"./data/{p.name}",
              })
          out.sort(key=lambda x: x["date"])

          (out_dir / "deepstate_dates.json").write_text(
              json.dumps(out, ensure_ascii=False, indent=2),
              encoding="utf-8"
          )

          print(f"Latest upstream: {latest_path.name} ({latest_date})")
          print(f"Wrote data/deepstate_dates.json with {len(out)} entries")
          PY

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git add -A data

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update DeepState data + dates index"
          git push
