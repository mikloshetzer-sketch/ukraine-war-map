name: Update DeepState GeoJSON (daily)

on:
  workflow_dispatch:
  schedule:
    # naponta 03:30 UTC körül (a forrás repo 03:00 UTC körül frissül)
    - cron: "30 3 * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare folders
        run: |
          mkdir -p data

      - name: Fetch latest DeepState GeoJSON from cyterat/deepstate-map-data
        env:
          API_URL: https://api.github.com/repos/cyterat/deepstate-map-data/contents/data
        run: |
          set -euo pipefail

          echo "Listing: $API_URL"
          # Lekérjük a data/ mappa tartalmát (JSON), kivesszük a deepstatemap_data_YYYY-MM-DD.geojson fájlokat,
          # név szerint sorba rendezzük, és a legutolsót választjuk.
          LATEST_NAME=$(curl -fsSL "$API_URL" \
            | jq -r '.[].name' \
            | grep -E '^deepstatemap_data_[0-9]{4}-[0-9]{2}-[0-9]{2}\.geojson$' \
            | sort \
            | tail -n 1)

          if [ -z "${LATEST_NAME:-}" ]; then
            echo "ERROR: Nem találtam deepstatemap_data_YYYY-MM-DD.geojson fájlt."
            exit 1
          fi

          echo "Latest file: $LATEST_NAME"

          # Letöltési URL kinyerése és a legfrissebb fájl letöltése
          DOWNLOAD_URL=$(curl -fsSL "$API_URL" | jq -r --arg n "$LATEST_NAME" '.[] | select(.name==$n) | .download_url')

          if [ -z "${DOWNLOAD_URL:-}" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "ERROR: Nem találtam download_url-t a kiválasztott fájlhoz."
            exit 1
          fi

          echo "Download: $DOWNLOAD_URL"
          curl -fsSL "$DOWNLOAD_URL" -o data/deepstate_latest.geojson

          # Meta infó (opcionális, hasznos)
          echo "$LATEST_NAME" > data/deepstate_latest.source.txt

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          git status --porcelain

          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add data/deepstate_latest.geojson data/deepstate_latest.source.txt
            git commit -m "Update DeepState latest GeoJSON"
            git push
          else
            echo "No changes to commit."
          fi
