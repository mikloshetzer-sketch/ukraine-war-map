name: Update DeepState GeoJSON (daily)

on:
  workflow_dispatch:
  schedule:
    - cron: "25 3 * * *"  # 03:25 UTC

permissions:
  contents: write

concurrency:
  group: update-deepstate
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (your repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download upstream ZIP (no git auth prompt)
        env:
          UPSTREAM_ZIP: "https://codeload.github.com/cytert/deepstate-map-data/zip/refs/heads/main"
        run: |
          set -euo pipefail
          rm -rf /tmp/deepstate_upstream
          mkdir -p /tmp/deepstate_upstream
          echo "Downloading: $UPSTREAM_ZIP"
          curl -L --fail "$UPSTREAM_ZIP" -o /tmp/deepstate_upstream/up.zip
          cd /tmp/deepstate_upstream
          unzip -q up.zip
          ls -la

      - name: Build DeepState index from upstream + copy latest
        run: |
          set -euo pipefail
          mkdir -p data

          python - <<'PY'
          import json, re, shutil
          from datetime import datetime
          from pathlib import Path

          base = Path("/tmp/deepstate_upstream")
          # zip kibontás után a mappa neve tipikusan: deepstate-map-data-main
          cand = list(base.glob("deepstate-map-data-*/data"))
          if not cand:
              raise SystemExit("Upstream extracted folder not found (deepstate-map-data-*/data).")
          upstream_data = cand[0]

          out_dir = Path("data")
          pat = re.compile(r"deepstate_map_data_(\d{8})\.geojson$", re.IGNORECASE)

          candidates = []
          for p in upstream_data.glob("deepstate_map_data_*.geojson"):
              m = pat.search(p.name)
              if not m:
                  continue
              ymd = m.group(1)
              try:
                  d = datetime.strptime(ymd, "%Y%m%d").date()
              except Exception:
                  continue
              candidates.append((d, p))

          if not candidates:
              raise SystemExit("No DeepState candidates found in upstream.")

          candidates.sort(key=lambda x: x[0])
          latest_date, latest_path = candidates[-1]

          # latest átmásolása a te repódba
          target_latest = out_dir / latest_path.name
          shutil.copyfile(latest_path, target_latest)

          # deepstate_latest.geojson
          shutil.copyfile(target_latest, out_dir / "deepstate_latest.geojson")

          # deepstate_dates.json generálás a HELYI data mappából (timeline)
          local_files = sorted(out_dir.glob("deepstate_map_data_*.geojson"))
          out = []
          for p in local_files:
              m = pat.search(p.name)
              if not m:
                  continue
              ymd = m.group(1)
              d = datetime.strptime(ymd, "%Y%m%d").date()
              out.append({
                  "date": d.isoformat(),
                  "name": p.name,
                  "raw": f"./data/{p.name}",
              })
          out.sort(key=lambda x: x["date"])

          (out_dir / "deepstate_dates.json").write_text(
              json.dumps(out, ensure_ascii=False, indent=2),
              encoding="utf-8"
          )

          print(f"Latest upstream: {latest_path.name} ({latest_date})")
          print(f"Wrote deepstate_dates.json with {len(out)} entries")
          PY

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git add data/deepstate_dates.json data/deepstate_latest.geojson data/deepstate_map_data_*.geojson || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update DeepState data + dates index"
          git push
