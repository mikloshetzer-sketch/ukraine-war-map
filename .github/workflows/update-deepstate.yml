name: Update DeepState GeoJSON (daily)

on:
  workflow_dispatch:
  schedule:
    - cron: "25 3 * * *"  # 03:25 UTC

permissions:
  contents: write

concurrency:
  group: update-deepstate
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (your repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Fetch DeepState data from upstream (git clone) + build index
        run: |
          set -euo pipefail
          mkdir -p data
          rm -rf /tmp/deepstate_upstream
          git clone --depth 1 https://github.com/cytert/deepstate-map-data.git /tmp/deepstate_upstream

          python - <<'PY'
          import json, re, shutil
          from datetime import datetime
          from pathlib import Path

          upstream_data = Path("/tmp/deepstate_upstream/data")
          if not upstream_data.exists():
              raise SystemExit("Upstream data folder not found: /tmp/deepstate_upstream/data")

          out_dir = Path("data")
          pat = re.compile(r"deepstate_map_data_(\d{8})\.geojson$", re.IGNORECASE)

          # Upstreamből kigyűjtjük a dátumos geojsonokat
          candidates = []
          for p in upstream_data.glob("deepstate_map_data_*.geojson"):
              m = pat.search(p.name)
              if not m:
                  continue
              ymd = m.group(1)
              try:
                  d = datetime.strptime(ymd, "%Y%m%d").date()
              except Exception:
                  continue
              candidates.append((d, p))

          if not candidates:
              raise SystemExit("No DeepState candidates found in upstream.")

          candidates.sort(key=lambda x: x[0])
          latest_date, latest_path = candidates[-1]

          # 1) legújabb átmásolása (és opcionálisan a teljes készlet szinkron)
          # Ha akarod: csak a latest-et másoljuk. De a timeline-hoz jobb, ha megmaradnak a régiek is.
          # Itt: a latest-et biztosan bemásoljuk; a többinek nem árt, ha marad.
          target_latest = out_dir / latest_path.name
          shutil.copyfile(latest_path, target_latest)

          # 2) deepstate_dates.json generálás a HELYI data mappából (ami nálad felgyűlt)
          local_files = sorted(out_dir.glob("deepstate_map_data_*.geojson"))
          out = []
          for p in local_files:
              m = pat.search(p.name)
              if not m:
                  continue
              ymd = m.group(1)
              d = datetime.strptime(ymd, "%Y%m%d").date()
              out.append({
                  "date": d.isoformat(),
                  "name": p.name,
                  "raw": f"./data/{p.name}",
              })
          out.sort(key=lambda x: x["date"])

          (out_dir / "deepstate_dates.json").write_text(
              json.dumps(out, ensure_ascii=False, indent=2),
              encoding="utf-8"
          )

          # 3) deepstate_latest.geojson
          shutil.copyfile(target_latest, out_dir / "deepstate_latest.geojson")

          print(f"Latest upstream: {latest_path.name} ({latest_date})")
          print(f"Wrote deepstate_dates.json with {len(out)} entries")
          PY

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git add data/deepstate_dates.json data/deepstate_latest.geojson data/deepstate_map_data_*.geojson || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update DeepState data + dates index"
          git push
