<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ukrajna háború – DeepState + műholdas hőpontok</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { height:100%; margin:0; }
#map { height:100%; }

.panel {
 position:absolute;
 z-index:1000;
 top:12px;
 left:12px;
 background:white;
 padding:12px;
 border-radius:10px;
 box-shadow:0 4px 16px rgba(0,0,0,0.2);
 font-family:Arial;
 width:420px;
}

.legend {
 position:absolute;
 bottom:20px;
 left:12px;
 z-index:1000;
 background:white;
 padding:10px;
 border-radius:10px;
 box-shadow:0 4px 16px rgba(0,0,0,0.2);
 font-size:12px;
}

.log {
 margin-top:8px;
 font-size:12px;
 background:#f3f3f3;
 padding:6px;
 border-radius:6px;
 height:100px;
 overflow:auto;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">
<b>Ukrajna háborús térkép</b><br>

<label><input type="checkbox" id="toggleDeepState" checked> Frontvonal</label><br>
<label><input type="checkbox" id="toggleFires" checked> Műholdas hőpontok</label><br>

Dátum: <span id="dateLabel">...</span><br>

<input id="daySlider" type="range" min="0" max="0" value="0" step="1" style="width:100%">

<div class="log" id="log">Indul...</div>
</div>

<div class="legend">
<b>Jelmagyarázat</b><br>
■ Frontvonal / megszállt terület<br>
■ Hőpont = robbanás / tűz / csapás (műhold)
</div>

<script>

const log = msg => document.getElementById("log").textContent += "\n"+msg;
const dateLabel = document.getElementById("dateLabel");
const slider = document.getElementById("daySlider");

let deepLayer = null;
let fireLayer = null;
let dates = [];
let currentDate = null;

const map = L.map('map').setView([48.8,31.5],6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
 attribution:'OSM'
}).addTo(map);

async function loadJSON(url){
 const r = await fetch(url);
 if(!r.ok) throw new Error("HTTP "+r.status);
 return await r.json();
}

function renderDeepState(data){
 if(deepLayer) map.removeLayer(deepLayer);

 deepLayer = L.geoJSON(data,{
   style:{
     color:"#d00",
     weight:2,
     fillColor:"#6b0000",
     fillOpacity:0.3
   }
 });

 if(document.getElementById("toggleDeepState").checked)
   deepLayer.addTo(map);
}

function loadFireLayer(date){

 const url =
 `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_Thermal_Anomalies_375m_All/default/${date}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png`;

 if(fireLayer) map.removeLayer(fireLayer);

 fireLayer = L.tileLayer(url,{
   opacity:0.65,
   attribution:"NASA GIBS"
 });

 if(document.getElementById("toggleFires").checked)
   fireLayer.addTo(map);
}

async function loadDate(index){
 const item = dates[index];
 if(!item) return;

 currentDate = item.date;
 dateLabel.textContent = item.date;

 try{
   const data = await loadJSON(item.raw);
   renderDeepState(data);
   loadFireLayer(item.date);
 }catch(e){
   log("Hiba: "+e);
 }
}

async function init(){
 try{
   const idx = await loadJSON("./data/deepstate_dates.json");
   dates = idx;

   slider.max = dates.length-1;
   slider.value = dates.length-1;

   slider.oninput = ()=> loadDate(slider.value);

   loadDate(slider.value);

   log("Kész ✔");

 }catch(e){
   log("Init hiba "+e);
 }
}

document.getElementById("toggleDeepState").onchange=()=>{
 if(deepLayer){
   if(toggleDeepState.checked) deepLayer.addTo(map);
   else map.removeLayer(deepLayer);
 }
};

document.getElementById("toggleFires").onchange=()=>{
 if(fireLayer){
   if(toggleFires.checked) fireLayer.addTo(map);
   else map.removeLayer(fireLayer);
 }
};

init();

</script>
</body>
</html>
