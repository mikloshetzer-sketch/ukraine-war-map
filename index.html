<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ukrán–orosz háború – DeepState + FIRMS + GIBS + Kivonat + Drón + ISW</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Esri Leaflet (ISW ArcGIS rétegekhez) -->
  <script src="https://unpkg.com/esri-leaflet@3.0.14/dist/esri-leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; background: #fff; }

    :root{
      --bg: rgba(255,255,255,0.95);
      --border: 1px solid rgba(0,0,0,0.08);
      --shadow: 0 6px 18px rgba(0,0,0,0.15);
      --radius: 12px;
      --gap: 10px;
      --font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    .panel {
      position: absolute;
      z-index: 1000;
      background: var(--bg);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      font: var(--font);
      overflow: hidden;
      max-width: 560px;
    }

    .panel .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.98);
    }

    .panel .head h3{
      margin:0;
      font-size: 13px;
    }
    .panel .head .sub{
      margin-top:4px;
      font-size: 12px;
      color:#555;
    }

    .panel .toggleBtn{
      border:0;
      background:#111;
      color:#fff;
      border-radius: 10px;
      padding: 7px 10px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }

    .panel .body{ padding: 0 12px 12px; }

    .row{
      display:flex;
      gap: var(--gap);
      align-items:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      background:#f2f2f2;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      user-select:none;
    }

    .btn{
      border:0;
      border-radius: 10px;
      padding: 8px 10px;
      background:#111;
      color:#fff;
      cursor:pointer;
      font-size: 12px;
    }
    .btn.secondary{ background:#444; }
    .btn.ghost{ background:#fff; color:#111; border:1px solid rgba(0,0,0,0.15); }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }

    select, input[type="text"], input[type="date"]{
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background:#fff;
      font-size: 12px;
    }

    .sliderRow{
      display:flex;
      gap: 10px;
      align-items:center;
      width:100%;
      margin-top: 10px;
    }
    input[type="range"]{ width: 100%; }

    .log{
      margin-top: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      background:#f6f6f6;
      border-radius: 10px;
      padding: 8px;
      max-height: 170px;
      overflow:auto;
    }
    .hidden{ display:none; }

    /* Summary box */
    .summary{
      margin-top: 10px;
      background: #f7f7ff;
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
    }
    .summary b{ display:block; margin-bottom: 6px; }
    .summary .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
    }
    .kpi{ display:flex; gap:6px; align-items:baseline; }
    .kpi .label{ color:#444; }
    .kpi .val{ font-weight:700; }

    /* Desktop positions */
    #panelLeft{ top: 12px; left: 12px; }
    #panelRight{ top: 12px; right: 12px; }

    /* Collapsed */
    .collapsed .body{ display:none; }

    /* Legend */
    #legend{
      position:absolute;
      z-index:1000;
      left: 12px;
      bottom: 12px;
      background: var(--bg);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      font: var(--font);
      max-width: 760px;
      overflow:hidden;
    }
    #legend .legendHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    #legend .legendHead b{ margin:0; font-size:12px; }
    #legend .legendToggle{
      border:0;
      background:#111;
      color:#fff;
      border-radius: 10px;
      padding: 6px 9px;
      cursor:pointer;
      font-size:12px;
    }
    #legend .legendBody{ margin-top: 8px; }
    #legend .item{ display:flex; align-items:center; gap:8px; margin:4px 0; font-size:12px; }
    .swatch{ width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,0.2); }

    #legend.collapsed .legendBody{ display:none; }

    /* Mobile layout */
    @media (max-width: 820px){
      #panelLeft, #panelRight{
        left: 10px !important;
        right: 10px !important;
        max-width: none !important;
      }
      #panelLeft{ top: 10px !important; }
      #panelRight{
        top: auto !important;
        bottom: 128px !important; /* legend fölé */
      }
      #legend{
        left: 10px !important;
        right: 10px !important;
        bottom: 10px !important;
        max-width: none !important;
      }
      .panel .toggleBtn{ padding: 8px 12px; }
      .chip{ padding: 8px 10px; }
      .btn{ padding: 10px 12px; font-size: 13px; }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- LEFT PANEL -->
  <div id="panelLeft" class="panel">
    <div class="head">
      <div>
        <h3>Rétegek & nézet</h3>
        <div class="sub">Kivonat + drón pontok + ISW overlay (opcionális).</div>
      </div>
      <button id="toggleLeft" class="toggleBtn" type="button">☰</button>
    </div>
    <div class="body">
      <div class="row">
        <label class="chip"><input id="chkDeep" type="checkbox" checked> DeepState</label>
        <label class="chip"><input id="chkFirms" type="checkbox" checked> FIRMS pötty</label>
        <label class="chip"><input id="chkGibs" type="checkbox"> NASA GIBS overlay</label>
        <label class="chip"><input id="chkDrones" type="checkbox" checked> Drón pontok</label>
        <label class="chip"><input id="chkISWControl" type="checkbox"> ISW kontroll</label>
        <label class="chip"><input id="chkISWFront" type="checkbox"> ISW front</label>
        <label class="chip"><input id="chkLog" type="checkbox" checked> Napló</label>
      </div>

      <div class="row">
        <span class="chip">Alaptérkép:
          <select id="selBase">
            <option value="osm" selected>OSM</option>
            <option value="sat">Műhold (ESRI)</option>
          </select>
        </span>

        <span class="chip">Zoom mód:
          <select id="selZoom">
            <option value="front" selected>Frontvonal</option>
            <option value="ukr">Ukrajna</option>
            <option value="click">Kattintásra</option>
          </select>
        </span>

        <button id="btnZoom" class="btn" type="button">Rázoomolás</button>
        <button id="btnZoomUA" class="btn ghost" type="button">Ukrajna</button>
      </div>

      <div class="row">
        <span class="chip">FIRMS napok:
          <select id="selDays">
            <option value="3">3</option>
            <option value="7">7</option>
            <option value="10" selected>10</option>
          </select>
        </span>

        <span class="chip">Max pötty/nap:
          <select id="selMaxPts">
            <option value="500">500</option>
            <option value="1500" selected>1500</option>
            <option value="3000">3000</option>
          </select>
        </span>
      </div>

      <div class="row">
        <span class="chip">GIBS réteg:
          <select id="selGibs">
            <option value="viirs375" selected>VIIRS Thermal (375m)</option>
            <option value="modis1k">MODIS Thermal (1km)</option>
          </select>
        </span>

        <span class="chip">Áttetsző:
          <input id="rngGibs" type="range" min="0" max="1" value="0.55" step="0.05" style="width:140px">
        </span>
      </div>

      <div class="row">
        <span class="chip" id="keyInfo">FIRMS kulcs: …</span>
        <button id="btnReloadFirms" class="btn secondary" type="button">FIRMS újratöltés</button>
      </div>

      <div id="summary" class="summary">
        <b>Napi/heti kivonat</b>
        <div class="grid">
          <div class="kpi"><span class="label">Napi Δ:</span> <span class="val" id="sumDay">–</span></div>
          <div class="kpi"><span class="label">Heti Δ:</span> <span class="val" id="sumWeek">–</span></div>
          <div class="kpi"><span class="label">Napi értelmezés:</span> <span class="val" id="sumDayTxt">–</span></div>
          <div class="kpi"><span class="label">Heti értelmezés:</span> <span class="val" id="sumWeekTxt">–</span></div>
        </div>
        <div class="mini" id="sumWhere">Változás helye: –</div>
        <div class="mini" style="margin-top:6px;">
          Megjegyzés: “megszállt terület” nő → orosz területszerzés; csökken → ukrán visszafoglalás.
        </div>
      </div>

      <div id="log" class="log">Indul…</div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div id="panelRight" class="panel">
    <div class="head">
      <div>
        <h3>Idősáv</h3>
        <div class="sub">Lejátszás + csúszka (timeline).</div>
      </div>
      <button id="toggleRight" class="toggleBtn" type="button">☰</button>
    </div>
    <div class="body">
      <div class="row">
        <span class="chip">Dátum: <b id="lblDate">…</b></span>
        <span class="chip">Fájl: <span id="lblFile">…</span></span>
      </div>

      <div class="row">
        <span class="chip">Sebesség:
          <select id="selSpeed">
            <option value="300" selected>0.3s</option>
            <option value="600">0.6s</option>
            <option value="1200">1.2s</option>
            <option value="2000">2.0s</option>
          </select>
        </span>
        <button id="btnPlay" class="btn" type="button" disabled>Lejátszás</button>
        <button id="btnStepBack" class="btn ghost" type="button">◀</button>
        <button id="btnStepFwd" class="btn ghost" type="button">▶</button>
      </div>

      <div class="sliderRow">
        <input id="rngDay" type="range" min="0" max="0" value="0" step="1" disabled />
      </div>

      <div class="row">
        <span class="chip">Ugrás dátumra:
          <input id="jumpDate" type="date" />
        </span>
        <button id="btnJump" class="btn secondary" type="button">Ugrás</button>
      </div>
    </div>
  </div>

  <!-- LEGEND -->
  <div id="legend">
    <div class="legendHead">
      <b>Jelmagyarázat</b>
      <button id="btnLegend" class="legendToggle" type="button">▼</button>
    </div>
    <div class="legendBody">
      <div class="item"><span class="swatch" style="background:#6b0000;"></span>DeepState megszállt terület (kitöltés)</div>
      <div class="item"><span class="swatch" style="background:#d00;"></span>DeepState határ/frontvonal</div>
      <div class="item"><span class="swatch" style="background:#ff5500;"></span>FIRMS hőpont</div>
      <div class="item"><span class="swatch" style="background:#0077ff;"></span>Drón pont (OSINT híralapú)</div>
      <div class="item"><span class="swatch" style="background:rgba(255,255,255,0); border:1px dashed rgba(0,0,0,0.35);"></span>GIBS: hőtérkép overlay</div>
      <div class="item"><span class="swatch" style="background:rgba(170,0,0,0.25); border:1px solid rgba(170,0,0,0.6);"></span>ISW kontroll (példa színezés)</div>
      <div class="item"><span class="swatch" style="background:rgba(255,0,0,0.0); border:2px solid rgba(255,0,0,0.85);"></span>ISW front (vonal)</div>
    </div>
  </div>

<script>
(() => {
  // ====== FIRMS MAP_KEY (idézőjelek maradnak!) ======
  const FIRMS_MAP_KEY = "44b266fd8324db5a0a9866017429dc43";

  // ====== ISW ArcGIS (B opció) – IDE másold be a REST URL-eket ======
  // Példa formátum:
  // "https://servicesX.arcgis.com/.../arcgis/rest/services/.../FeatureServer/0"
  const ISW_CONTROL_URL = "";   // kontroll poligon layer
  const ISW_FRONTLINE_URL = ""; // frontvonal layer

  const UKRAINE_BBOX = "22,44,40,53"; // FIRMS area bbox: lonmin,latmin,lonmax,latmax
  const UKRAINE_BOUNDS_RAW = { sw: [44.0, 22.0], ne: [52.7, 40.2] };

  const el = (id) => document.getElementById(id);

  const panelLeft = el("panelLeft");
  const panelRight = el("panelRight");
  const toggleLeft = el("toggleLeft");
  const toggleRight = el("toggleRight");

  const chkDeep = el("chkDeep");
  const chkFirms = el("chkFirms");
  const chkGibs = el("chkGibs");
  const chkDrones = el("chkDrones");
  const chkISWControl = el("chkISWControl");
  const chkISWFront = el("chkISWFront");
  const chkLog = el("chkLog");

  const selBase = el("selBase");
  const selZoom = el("selZoom");
  const btnZoom = el("btnZoom");
  const btnZoomUA = el("btnZoomUA");

  const selDays = el("selDays");
  const selMaxPts = el("selMaxPts");
  const keyInfo = el("keyInfo");
  const btnReloadFirms = el("btnReloadFirms");

  const selGibs = el("selGibs");
  const rngGibs = el("rngGibs");

  const logEl = el("log");

  const lblDate = el("lblDate");
  const lblFile = el("lblFile");
  const selSpeed = el("selSpeed");
  const btnPlay = el("btnPlay");
  const btnStepBack = el("btnStepBack");
  const btnStepFwd = el("btnStepFwd");
  const rngDay = el("rngDay");
  const jumpDate = el("jumpDate");
  const btnJump = el("btnJump");

  const legend = el("legend");
  const btnLegend = el("btnLegend");

  const sumDay = el("sumDay");
  const sumWeek = el("sumWeek");
  const sumDayTxt = el("sumDayTxt");
  const sumWeekTxt = el("sumWeekTxt");
  const sumWhere = el("sumWhere");

  function log(msg){
    if(!chkLog.checked) return;
    logEl.textContent += "\n" + msg;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function setLogVisible(on){
    logEl.classList.toggle("hidden", !on);
  }
  chkLog.addEventListener("change", () => setLogVisible(chkLog.checked));
  setLogVisible(true);

  function isMobile(){
    return window.matchMedia && window.matchMedia("(max-width: 820px)").matches;
  }
  function collapseForMobile(){
    if(isMobile()){
      panelLeft.classList.add("collapsed");
      panelRight.classList.add("collapsed");
      legend.classList.add("collapsed");
      btnLegend.textContent = "▲";
    } else {
      panelLeft.classList.remove("collapsed");
      panelRight.classList.remove("collapsed");
      legend.classList.remove("collapsed");
      btnLegend.textContent = "▼";
    }
  }
  collapseForMobile();
  window.addEventListener("resize", collapseForMobile);

  toggleLeft.addEventListener("click", () => panelLeft.classList.toggle("collapsed"));
  toggleRight.addEventListener("click", () => panelRight.classList.toggle("collapsed"));
  btnLegend.addEventListener("click", () => {
    legend.classList.toggle("collapsed");
    btnLegend.textContent = legend.classList.contains("collapsed") ? "▲" : "▼";
  });

  if(!window.L){
    alert("Leaflet nem töltött be.");
    return;
  }

  // ===== Map init =====
  const map = L.map("map").setView([49.0, 31.0], 6);

  const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19, attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  const esriSat = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 19, attribution: "Tiles &copy; Esri" }
  );

  const UKRAINE_BOUNDS = L.latLngBounds(
    L.latLng(UKRAINE_BOUNDS_RAW.sw[0], UKRAINE_BOUNDS_RAW.sw[1]),
    L.latLng(UKRAINE_BOUNDS_RAW.ne[0], UKRAINE_BOUNDS_RAW.ne[1])
  );

  selBase.addEventListener("change", () => {
    if(selBase.value === "sat"){ map.removeLayer(osm); esriSat.addTo(map); }
    else { map.removeLayer(esriSat); osm.addTo(map); }
  });

  // Click-to-zoom option
  let clickZoomEnabled = false;
  selZoom.addEventListener("change", () => clickZoomEnabled = (selZoom.value === "click"));
  map.on("click", async (e) => {
    if(clickZoomEnabled){
      map.setView(e.latlng, Math.max(map.getZoom(), 10), { animate:true });
    }
  });

  // ===== Reverse geocode (település) – best effort =====
  async function reversePlace(lat, lon){
    try{
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&zoom=12&addressdetails=1`;
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok) return null;
      const j = await r.json();
      return j?.name || j?.display_name || null;
    }catch(e){ return null; }
  }

  // ===== Layers =====
  let deepLayer = null;
  let gibsLayer = null;

  const firmsLayer = L.layerGroup().addTo(map);
  const dronesLayer = L.layerGroup().addTo(map);

  // ISW layers
  let iswControlLayer = null;
  let iswFrontLayer = null;

  function setVisible(layer, on){
    if(!layer) return;
    if(on) layer.addTo(map);
    else if(map.hasLayer(layer)) map.removeLayer(layer);
  }

  chkDeep.addEventListener("change", () => setVisible(deepLayer, chkDeep.checked));
  chkFirms.addEventListener("change", () => setVisible(firmsLayer, chkFirms.checked));
  chkDrones.addEventListener("change", () => setVisible(dronesLayer, chkDrones.checked));
  chkGibs.addEventListener("change", () => { if(currentDate) setGibs(currentDate); });

  // ===== Helpers =====
  async function loadJson(url){
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`Fetch hiba: ${url} → HTTP ${r.status}`);
    return await r.json();
  }

  function renderDeepState(data){
    if(deepLayer) map.removeLayer(deepLayer);

    deepLayer = L.geoJSON(data, {
      style: (feat) => {
        const t = feat?.geometry?.type || "";
        const isLine = (t === "LineString" || t === "MultiLineString");
        if(isLine){
          return { color:"#d00", weight:2.2, opacity:0.95 };
        }
        return {
          color:"#d00", weight:2.0, opacity:0.95,
          fillColor:"#6b0000", fillOpacity:0.28
        };
      },
      onEachFeature: (feat, layer) => {
        layer.on("click", async (e) => {
          const lat = e.latlng.lat, lon = e.latlng.lng;
          const place = await reversePlace(lat, lon);
          layer.bindPopup(
            `<b>DeepState</b><br>` +
            `GPS: ${lat.toFixed(5)}, ${lon.toFixed(5)}<br>` +
            (place ? `<span style="color:#555">${place}</span>` : `<span style="color:#999">(nincs településnév)</span>`)
          ).openPopup();
        });
      }
    });

    setVisible(deepLayer, chkDeep.checked);
  }

  function doZoom(){
    const mode = selZoom.value;
    if(mode === "front" && deepLayer){
      const b = deepLayer.getBounds();
      if(b && b.isValid && b.isValid()) map.fitBounds(b.pad(0.12));
      return;
    }
    if(mode === "ukr") map.fitBounds(UKRAINE_BOUNDS.pad(0.08));
  }
  btnZoom.addEventListener("click", doZoom);
  btnZoomUA.addEventListener("click", () => map.fitBounds(UKRAINE_BOUNDS.pad(0.08)));

  // ===== GIBS overlay (WMTS) =====
  function gibsTemplateFor(sel){
    if(sel === "modis1k"){
      return "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_Thermal_Anomalies_All/default/{date}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png";
    }
    return "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_Thermal_Anomalies_375m_All/default/{date}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png";
  }

  function setGibs(dateStr){
    if(!chkGibs.checked){
      if(gibsLayer && map.hasLayer(gibsLayer)) map.removeLayer(gibsLayer);
      return;
    }
    const url = gibsTemplateFor(selGibs.value).replace("{date}", dateStr);
    const op = Number(rngGibs.value || "0.55");
    if(!gibsLayer){
      gibsLayer = L.tileLayer(url, { opacity: op, maxZoom: 19, maxNativeZoom: 9, attribution:"NASA GIBS" });
    } else {
      gibsLayer.setUrl(url);
      gibsLayer.setOpacity(op);
    }
    gibsLayer.addTo(map);
  }

  selGibs.addEventListener("change", () => { if(currentDate) setGibs(currentDate); });
  rngGibs.addEventListener("input", () => { if(gibsLayer) gibsLayer.setOpacity(Number(rngGibs.value||"0.55")); });

  // ===== Summary (daily/weekly + change centroid) =====
  function fmtDeltaKm2(d){
    if(d === null || d === undefined || !Number.isFinite(d)) return "n/a";
    const sign = d > 0 ? "+" : (d < 0 ? "−" : "±");
    const val = Math.abs(d);
    if(val >= 1000) return `${sign}${val.toFixed(0)} km²`;
    if(val >= 100) return `${sign}${val.toFixed(1)} km²`;
    return `${sign}${val.toFixed(2)} km²`;
  }

  async function loadSummary(){
    try{
      const daily = await loadJson("./data/summary_daily.json");
      const weekly = await loadJson("./data/summary_weekly.json");
      const change = await loadJson("./data/change_latest.json");

      sumDay.textContent = fmtDeltaKm2(Number(daily.delta_km2));
      sumWeek.textContent = fmtDeltaKm2(Number(weekly.delta_km2));
      sumDayTxt.textContent = daily.interpretation || "–";
      sumWeekTxt.textContent = weekly.interpretation || "–";

      const gained = change.gained_centroid; // [lon,lat]
      const lost = change.lost_centroid;     // [lon,lat]

      let line = `Változás helye: `;
      const d = Number(daily.delta_km2);

      if (d > 0 && gained){
        line += `(+): ${gained[1].toFixed(4)}, ${gained[0].toFixed(4)} — <b>orosz területszerzés</b>`;
      } else if (d < 0 && lost){
        line += `(−): ${lost[1].toFixed(4)}, ${lost[0].toFixed(4)} — <b>ukrán visszafoglalás</b>`;
      } else {
        line += "–";
      }
      sumWhere.textContent = line;
      log("Kivonat: betöltve ✔");
    }catch(e){
      log("Kivonat: nincs még / hiba – " + String(e));
    }
  }

  // ===== FIRMS (API CSV) =====
  let firmsByDate = {};

  function parseCSV(csvText){
    const lines = csvText.split(/\r?\n/).filter(Boolean);
    if(lines.length <= 1) return [];
    const header = lines[0].split(",");
    const idx = (name) => header.indexOf(name);
    const iLat = idx("latitude"), iLon = idx("longitude"), iDate = idx("acq_date"), iTime = idx("acq_time");
    const iSat = idx("satellite"), iConf = idx("confidence"), iFRP = idx("frp");
    const out = [];
    for(let k=1; k<lines.length; k++){
      const c = lines[k].split(",");
      if(c.length < header.length) continue;
      const lat = parseFloat(c[iLat]), lon = parseFloat(c[iLon]);
      if(!Number.isFinite(lat) || !Number.isFinite(lon)) continue;
      out.push({
        lat, lon,
        acq_date: c[iDate] ?? "",
        acq_time: c[iTime] ?? "",
        frp: c[iFRP] ?? "",
        sat: c[iSat] ?? "",
        conf: c[iConf] ?? ""
      });
    }
    return out;
  }

  function fmtTime(acq){
    const s = (acq||"").toString().padStart(4,"0");
    return s.length===4 ? (s.slice(0,2)+":"+s.slice(2,4)) : s;
  }

  async function fetchFirms(){
    firmsByDate = {};
    firmsLayer.clearLayers();

    const keyOk = (FIRMS_MAP_KEY && FIRMS_MAP_KEY.length >= 10);
    if(!keyOk){
      keyInfo.textContent = "FIRMS kulcs: NINCS";
      log("FIRMS: nincs MAP_KEY beállítva.");
      return;
    }
    keyInfo.textContent = "FIRMS kulcs: OK (" + FIRMS_MAP_KEY.slice(0,4) + "…)";

    const days = Number(selDays.value) || 10;
    const products = ["VIIRS_SNPP_NRT", "VIIRS_NOAA20_NRT"];
    let total = 0;

    for(const prod of products){
      const url = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/${encodeURIComponent(FIRMS_MAP_KEY)}/${prod}/${UKRAINE_BBOX}/${days}`;
      log(`FIRMS fetch: ${prod} | last ${days} days`);
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok){ log(`FIRMS HTTP hiba (${prod}): ${r.status}`); continue; }
      const txt = await r.text();
      const pts = parseCSV(txt);
      total += pts.length;
      for(const p of pts){
        if(!p.acq_date) continue;
        (firmsByDate[p.acq_date] ||= []).push(p);
      }
    }
    log(`FIRMS pontok összesen: ${total}`);
    if(currentDate) renderFirmsForDate(currentDate);
  }

  function renderFirmsForDate(dateStr){
    firmsLayer.clearLayers();
    if(!chkFirms.checked) return;

    const pts = firmsByDate[dateStr] || [];
    const maxPts = Number(selMaxPts.value) || 1500;

    if(pts.length === 0){
      log(`FIRMS: 0 pont erre a napra: ${dateStr}`);
      return;
    }

    const use = pts.length > maxPts ? pts.slice(0, maxPts) : pts;

    for(const p of use){
      const frp = Number(p.frp);
      const radius = Number.isFinite(frp) ? Math.max(3, Math.min(9, 2 + frp/20)) : 4;

      const m = L.circleMarker([p.lat, p.lon], {
        radius, color:"#ff5500", weight:1, opacity:0.9, fillOpacity:0.65
      });

      m.on("click", async (e) => {
        const place = await reversePlace(p.lat, p.lon);
        const popup =
          `<b>FIRMS hőpont</b><br>` +
          `Dátum: ${p.acq_date}<br>` +
          `Idő (UTC): ${fmtTime(p.acq_time)}<br>` +
          `GPS: ${p.lat.toFixed(5)}, ${p.lon.toFixed(5)}<br>` +
          (place ? `<span style="color:#555">${place}</span><br>` : "") +
          `FRP: ${p.frp||"-"} | Conf: ${p.conf||"-"} | Sat: ${p.sat||"-"}`;
        m.bindPopup(popup).openPopup();
      });

      firmsLayer.addLayer(m);
    }
    log(`FIRMS: ${use.length}/${pts.length} pont kirajzolva (${dateStr})`);
  }

  btnReloadFirms.addEventListener("click", fetchFirms);
  selDays.addEventListener("change", fetchFirms);
  selMaxPts.addEventListener("change", () => { if(currentDate) renderFirmsForDate(currentDate); });

  // ===== Drones (GeoJSON) =====
  async function loadDrones(){
    dronesLayer.clearLayers();
    try{
      const gj = await loadJson("./data/drones_latest.geojson");
      const feats = gj.features || [];
      for(const f of feats){
        if(!f.geometry || f.geometry.type !== "Point") continue;
        const [lon, lat] = f.geometry.coordinates || [];
        if(typeof lon !== "number" || typeof lat !== "number") continue;

        const p = f.properties || {};
        const title = p.title || "Drone-related (OSINT)";
        const url = p.url ? `<br><a href="${p.url}" target="_blank" rel="noopener">Forrás</a>` : "";

        const m = L.circleMarker([lat, lon], { radius: 5, color:"#0077ff", weight:2, fillOpacity:0.55 });

        m.on("click", async () => {
          const place = await reversePlace(lat, lon);
          m.bindPopup(
            `<b>Drón pont</b><br>${title}${url}<br>` +
            `GPS: ${lat.toFixed(5)}, ${lon.toFixed(5)}<br>` +
            (place ? `<span style="color:#555">${place}</span>` : "")
          ).openPopup();
        });

        dronesLayer.addLayer(m);
      }
      log(`Drón pontok: betöltve ✔ (${feats.length})`);
      setVisible(dronesLayer, chkDrones.checked);
    } catch(e){
      log("Drón pontok: nincs még / hiba – " + String(e));
    }
  }

  // ===== ISW (Esri FeatureLayer) =====
  function ensureISW(){
    if(ISW_CONTROL_URL && !iswControlLayer){
      iswControlLayer = L.esri.featureLayer({
        url: ISW_CONTROL_URL,
        style: (feature) => {
          // Heurisztikus színezés (attribútumtól függően lehet finomítani)
          const props = feature?.properties || {};
          const txt = JSON.stringify(props).toLowerCase();
          let fill = "rgba(170,0,0,0.25)";
          let stroke = "rgba(170,0,0,0.65)";

          if(txt.includes("ukrain") || txt.includes("ua")){
            fill = "rgba(0,90,200,0.18)";
            stroke = "rgba(0,90,200,0.55)";
          } else if(txt.includes("contested") || txt.includes("disputed") || txt.includes("grey") || txt.includes("gray")){
            fill = "rgba(255,140,0,0.18)";
            stroke = "rgba(255,140,0,0.65)";
          }
          return { color: stroke, weight: 1.4, fillColor: fill, fillOpacity: 1 };
        }
      });
      iswControlLayer.on("click", async (e) => {
        const lat = e.latlng.lat, lon = e.latlng.lng;
        const place = await reversePlace(lat, lon);
        const props = e.layer?.feature?.properties || {};
        const keys = Object.keys(props).slice(0, 12);
        const rows = keys.map(k => `<div><b>${k}</b>: ${String(props[k])}</div>`).join("");
        L.popup().setLatLng(e.latlng).setContent(
          `<b>ISW kontroll</b><br>` +
          `GPS: ${lat.toFixed(5)}, ${lon.toFixed(5)}<br>` +
          (place ? `<span style="color:#555">${place}</span><br>` : "") +
          `<hr style="margin:6px 0"/>` +
          (rows || "<i>Nincs attribútum</i>")
        ).openOn(map);
      });
    }

    if(ISW_FRONTLINE_URL && !iswFrontLayer){
      iswFrontLayer = L.esri.featureLayer({
        url: ISW_FRONTLINE_URL,
        style: () => ({ color:"rgba(255,0,0,0.85)", weight: 2 })
      });
      iswFrontLayer.on("click", async (e) => {
        const lat = e.latlng.lat, lon = e.latlng.lng;
        const place = await reversePlace(lat, lon);
        L.popup().setLatLng(e.latlng).setContent(
          `<b>ISW front</b><br>` +
          `GPS: ${lat.toFixed(5)}, ${lon.toFixed(5)}<br>` +
          (place ? `<span style="color:#555">${place}</span>` : "")
        ).openOn(map);
      });
    }
  }

  function syncISW(){
    // okosan: ha nincs URL, ne engedje bekapcsolni
    if(chkISWControl.checked && !ISW_CONTROL_URL){
      chkISWControl.checked = false;
      log("ISW kontroll: nincs URL beállítva a kódban.");
    }
    if(chkISWFront.checked && !ISW_FRONTLINE_URL){
      chkISWFront.checked = false;
      log("ISW front: nincs URL beállítva a kódban.");
    }

    ensureISW();

    if(iswControlLayer){
      if(chkISWControl.checked) iswControlLayer.addTo(map);
      else if(map.hasLayer(iswControlLayer)) map.removeLayer(iswControlLayer);
    }
    if(iswFrontLayer){
      if(chkISWFront.checked) iswFrontLayer.addTo(map);
      else if(map.hasLayer(iswFrontLayer)) map.removeLayer(iswFrontLayer);
    }
  }

  chkISWControl.addEventListener("change", syncISW);
  chkISWFront.addEventListener("change", syncISW);

  // ===== Timeline =====
  let dates = [];
  let currentDate = null;
  let playing = false;
  let timer = null;

  function stopPlay(){
    playing = false;
    btnPlay.textContent = "Lejátszás";
    if(timer){ clearInterval(timer); timer = null; }
  }

  function stepOnce(dir=+1){
    let v = Number(rngDay.value);
    const max = Number(rngDay.max);
    const min = Number(rngDay.min);

    if(dir > 0){
      v = (v >= max) ? min : v + 1;
    }else{
      v = (v <= min) ? max : v - 1;
    }

    rngDay.value = String(v);
    loadByIndex(v, false);
  }

  function startPlay(){
    playing = true;
    btnPlay.textContent = "Megállítás";
    timer = setInterval(() => stepOnce(+1), Number(selSpeed.value) || 300);
  }

  btnPlay.addEventListener("click", () => {
    if(playing) stopPlay();
    else startPlay();
  });

  selSpeed.addEventListener("change", () => {
    if(playing){ stopPlay(); startPlay(); }
  });

  btnStepBack.addEventListener("click", () => { stopPlay(); stepOnce(-1); });
  btnStepFwd.addEventListener("click", () => { stopPlay(); stepOnce(+1); });

  rngDay.addEventListener("input", () => {
    stopPlay();
    loadByIndex(Number(rngDay.value), false);
  });

  btnJump.addEventListener("click", () => {
    stopPlay();
    const d = jumpDate.value;
    if(!d || !dates.length) return;
    let bestI = 0, bestDiff = Infinity;
    const target = new Date(d).getTime();
    dates.forEach((it, i) => {
      const t = new Date(it.date).getTime();
      const diff = Math.abs(t - target);
      if(diff < bestDiff){ bestDiff = diff; bestI = i; }
    });
    rngDay.value = String(bestI);
    loadByIndex(bestI, true);
  });

  // ===== deepstate_dates.json: támogatunk több sémát =====
  function normalizeDeepstateIndex(raw){
    // 1) ha {dates:[...]}:
    let arr = Array.isArray(raw) ? raw : (raw?.dates || []);
    if(!Array.isArray(arr)) arr = [];

    // 2) normalizáljuk, hogy legyen: {date, name, raw}
    // - ha elemen belül van raw -> ok
    // - ha file -> raw = file
    // - ha name nincs -> generáljuk
    const norm = arr
      .filter(x => x && x.date && (x.raw || x.file))
      .map(x => ({
        date: x.date,
        name: x.name || x.file || x.raw || x.date,
        raw: x.raw || x.file
      }))
      .sort((a,b) => a.date.localeCompare(b.date));

    return norm;
  }

  async function loadByIndex(i, doZoomNow=true){
    const item = dates[i];
    if(!item) return;

    currentDate = item.date;
    lblDate.textContent = item.date;
    lblFile.textContent = item.name || item.date;
    jumpDate.value = item.date;

    const data = await loadJson(item.raw);
    renderDeepState(data);

    setGibs(item.date);
    renderFirmsForDate(item.date);

    if(doZoomNow) doZoom();
  }

  // ===== Init =====
  async function init(){
    log("Indul…");

    try{
      const ds = await loadJson("./data/deepstate_dates.json");
      dates = normalizeDeepstateIndex(ds);

      if(!Array.isArray(dates) || dates.length === 0){
        throw new Error("Üres / ismeretlen deepstate_dates.json formátum");
      }

      rngDay.min = "0";
      rngDay.max = String(dates.length - 1);
      rngDay.value = String(dates.length - 1);
      rngDay.disabled = false;

      await loadByIndex(dates.length - 1, true);

      await fetchFirms();
      await loadSummary();
      await loadDrones();

      // ISW only if URLs provided
      syncISW();

      btnPlay.disabled = false;
      log("Kész ✔");
    } catch(e){
      log("INIT HIBA: " + String(e));
    }
  }

  window.addEventListener("error", (e) => log("JS ERROR: " + (e.message || e.error || e)));
  window.addEventListener("unhandledrejection", (e) => log("PROMISE ERROR: " + (e.reason || e)));

  init();
})();
</script>
</body>
</html>
