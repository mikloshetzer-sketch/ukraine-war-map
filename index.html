<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ukrajna háborús térkép – FIRMS + DeepState</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{height:100%;margin:0;}
#map{height:100%;}

.panel{
position:absolute;top:12px;left:12px;right:12px;max-width:760px;
background:white;padding:12px;border-radius:12px;
box-shadow:0 4px 16px rgba(0,0,0,.2);font-family:Arial;z-index:1000;
}

.row{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;}
.legend{position:absolute;bottom:20px;left:12px;background:white;padding:10px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.2);font-size:12px;}
.log{margin-top:8px;background:#f3f3f3;padding:6px;border-radius:6px;height:110px;overflow:auto;font-size:12px;}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">
<b>Ukrajna – háborús dashboard</b><br>

<label><input type="checkbox" id="toggleDeep" checked> Frontvonal</label>
<label><input type="checkbox" id="toggleFirms" checked> FIRMS hőpontok</label>
<label><input type="checkbox" id="toggleGibs"> NASA hőtérkép (overlay)</label>

<br><br>

Dátum: <span id="dateLabel">...</span>

<input id="slider" type="range" min="0" max="0" step="1" style="width:100%">

<div class="log" id="log">Indul...</div>
</div>

<div class="legend">
<b>Jelmagyarázat</b><br>
■ Frontvonal<br>
● Hőpont (műhold detektált tűz / robbanás)
</div>

<script>

const FIRMS_MAP_KEY = "44b266fd8324db5a0a9866017429dc43";

const log = m => document.getElementById("log").textContent += "\n"+m;
const map = L.map('map').setView([48.8,31.5],6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let deepLayer=null;
let firmsLayer=null;
let gibsLayer=null;
let dates=[];

async function loadJSON(u){
const r=await fetch(u);
if(!r.ok)throw new Error(r.status);
return await r.json();
}

function renderDeep(data){
if(deepLayer)map.removeLayer(deepLayer);
deepLayer=L.geoJSON(data,{style:{color:"#d00",weight:2,fillColor:"#6b0000",fillOpacity:0.3}});
if(toggleDeep.checked)deepLayer.addTo(map);
}

async function loadFIRMS(date){

if(!FIRMS_MAP_KEY || FIRMS_MAP_KEY==="IDE_IRD_BE_A_KULCSOT"){
log("NINCS FIRMS KEY");
return;
}

// Ukrajna bounding box
const bbox="22,44,40,53";

const url=`https://firms.modaps.eosdis.nasa.gov/api/area/csv/${FIRMS_MAP_KEY}/VIIRS_SNPP_NRT/${bbox}/1/${date}`;

try{

const res=await fetch(url);
const txt=await res.text();

const rows=txt.split("\n").slice(1);

if(firmsLayer)map.removeLayer(firmsLayer);

firmsLayer=L.layerGroup();

rows.forEach(r=>{
const c=r.split(",");
if(c.length<6)return;

const lat=parseFloat(c[0]);
const lon=parseFloat(c[1]);
const bright=c[2];
const acq=c[5];

const m=L.circleMarker([lat,lon],{
radius:4,
color:"#ff5500",
fillOpacity:.7
}).bindPopup(`Hőpont<br>Idő:${acq}<br>Hő:${bright}`);

firmsLayer.addLayer(m);
});

if(toggleFirms.checked)firmsLayer.addTo(map);

}catch(e){log("FIRMS hiba "+e);}

}

function loadGIBS(date){
const url=`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_Thermal_Anomalies_375m_All/default/${date}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png`;
if(gibsLayer)map.removeLayer(gibsLayer);
gibsLayer=L.tileLayer(url,{opacity:.6,maxNativeZoom:9});
if(toggleGibs.checked)gibsLayer.addTo(map);
}

async function loadDate(i){
const item=dates[i];
if(!item)return;

document.getElementById("dateLabel").textContent=item.date;

const data=await loadJSON(item.raw);
renderDeep(data);
loadFIRMS(item.date);
loadGIBS(item.date);
}

async function init(){
try{
dates=await loadJSON("./data/deepstate_dates.json");
slider.max=dates.length-1;
slider.value=dates.length-1;
slider.oninput=()=>loadDate(slider.value);
loadDate(slider.value);
}catch(e){log(e);}
}

toggleDeep.onchange=()=>deepLayer&& (toggleDeep.checked?deepLayer.addTo(map):map.removeLayer(deepLayer));
toggleFirms.onchange=()=>firmsLayer&& (toggleFirms.checked?firmsLayer.addTo(map):map.removeLayer(firmsLayer));
toggleGibs.onchange=()=>gibsLayer&& (toggleGibs.checked?gibsLayer.addTo(map):map.removeLayer(gibsLayer));

init();

</script>
</body>
</html>
