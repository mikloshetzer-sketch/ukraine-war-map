<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ukrán–orosz háború – DeepState + FIRMS + NASA GIBS</title>

  <!-- Leaflet (jsDelivr – stabil) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; background: #fff; }

    :root{
      --panel-bg: rgba(255,255,255,0.95);
      --shadow: 0 6px 18px rgba(0,0,0,0.15);
      --radius: 12px;
      --gap: 10px;
      --font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --border: 1px solid rgba(0,0,0,0.08);
    }

    .panel {
      position: absolute;
      z-index: 1000;
      background: var(--panel-bg);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      font: var(--font);
      max-width: 440px;
      overflow: hidden;
    }
    .panel .head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
    }
    .panel .head h3 { margin: 0; font-size: 13px; }
    .panel .head .btnIcon{
      border:0; background:#111; color:#fff;
      border-radius: 10px; padding: 6px 9px;
      cursor: pointer; font-size: 12px;
    }
    .panel .body { padding: 0 12px 12px; }

    .muted { color:#555; font-size:12px; margin-top: 4px; }

    .leftPanel { top: 12px; left: 12px; }
    .rightPanel { top: 12px; right: 12px; }

    .row { display:flex; gap: var(--gap); align-items:center; flex-wrap:wrap; margin-top:10px; }

    .chip {
      display:inline-flex; align-items:center; gap:8px;
      background:#f2f2f2; padding:7px 10px; border-radius:999px; font-size:12px;
      user-select:none;
    }
    .chip b { font-weight: 700; }

    .btn {
      border:0; border-radius:10px; padding:8px 10px;
      background:#111; color:#fff; cursor:pointer; font-size:12px;
    }
    .btn.secondary { background:#444; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    select, input[type="text"] {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 12px;
    }

    .slider-wrap { display:flex; gap:10px; align-items:center; width:100%; margin-top:10px; }
    input[type="range"] { width: 100%; }

    .log {
      margin-top: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      background: #f6f6f6;
      border-radius: 10px;
      padding: 8px;
      max-height: 140px;
      overflow: auto;
    }
    .hidden { display:none; }

    .summary {
      margin-top: 10px;
      background: #f7f7ff;
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(0,0,0,0.06);
      font-size: 12px;
    }
    .summary b { display:block; margin-bottom: 6px; }
    .summary .grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
    }
    .kpi { display:flex; gap:6px; align-items:baseline; }
    .kpi .label { color:#444; }
    .kpi .val { font-weight: 700; }

    .legend {
      position: absolute;
      bottom: 16px;
      left: 12px;
      z-index: 1000;
      background: var(--panel-bg);
      padding: 10px 12px;
      border-radius: var(--radius);
      font-size: 12px;
      box-shadow: var(--shadow);
      border: var(--border);
      max-width: 560px;
    }
    .legend b { display:block; margin-bottom:6px; }
    .legend .item { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .swatch { width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,0.2); }

    /* collapsed state */
    .collapsed .body { display:none; }

    /* Mobile drawer behavior */
    @media (max-width: 820px){
      .leftPanel, .rightPanel {
        left: 10px; right: 10px;
        max-width: none;
      }
      .leftPanel { top: 10px; }
      .rightPanel { top: auto; bottom: 96px; }
      .legend{ bottom: 10px; left: 10px; right: 10px; max-width: none; }
      .btn{ padding: 10px 12px; font-size: 13px; }
      .chip{ padding: 8px 10px; }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- LEFT -->
  <div id="leftPanel" class="panel leftPanel">
    <div class="head">
      <div>
        <h3>Rétegek & nézet</h3>
        <div class="muted">Mobilon csukd össze a ☰ gombbal.</div>
      </div>
      <button id="leftToggleBtn" class="btnIcon" type="button" title="Összecsuk/kinyit">☰</button>
    </div>
    <div class="body">
      <div class="row">
        <label class="chip"><input id="toggleDeep" type="checkbox" checked> DeepState</label>
        <label class="chip"><input id="toggleFirms" type="checkbox" checked> FIRMS pötty</label>
        <label class="chip"><input id="toggleGibs" type="checkbox"> NASA GIBS hőtérkép</label>
        <label class="chip"><input id="toggleTroops" type="checkbox" checked> Csapatok</label>
      </div>

      <div class="row">
        <span class="chip">
          Alaptérkép:
          <select id="baseSel">
            <option value="osm" selected>OSM</option>
            <option value="sat">Műhold (ESRI)</option>
          </select>
        </span>

        <span class="chip">
          Zoom mód:
          <select id="zoomSel">
            <option value="front" selected>Frontvonal</option>
            <option value="ukr">Ukrajna</option>
            <option value="click">Kattintásra</option>
          </select>
        </span>

        <button id="zoomBtn" class="btn" type="button">Rázoomolás</button>
      </div>

      <div class="row">
        <span class="chip">FIRMS napok:
          <select id="firmsDaysSel">
            <option value="3">3</option>
            <option value="7">7</option>
            <option value="10" selected>10</option>
          </select>
        </span>

        <span class="chip">Max pötty/nap:
          <select id="maxPtsSel">
            <option value="500">500</option>
            <option value="1500" selected>1500</option>
            <option value="3000">3000</option>
          </select>
        </span>
      </div>

      <div class="row">
        <span class="chip">GIBS réteg:
          <select id="gibsSel">
            <option value="viirs375" selected>VIIRS Thermal Anomalies (375m)</option>
            <option value="modis1k">MODIS Thermal Anomalies (1km)</option>
          </select>
        </span>

        <span class="chip">GIBS áttetsző:
          <input id="gibsOpacity" type="range" min="0" max="1" value="0.55" step="0.05" style="width:120px">
        </span>
      </div>

      <div class="row">
        <span class="chip" id="keyStatus">FIRMS kulcs: …</span>
        <label class="chip"><input id="toggleLog" type="checkbox" checked> Napló</label>
        <button id="reloadTroopsBtn" class="btn secondary" type="button">Csapatok újratöltése</button>
      </div>

      <div id="summaryBox" class="summary">
        <b>Kivonat</b>
        <div class="grid">
          <div class="kpi"><span class="label">Terület Δ (nap):</span> <span class="val" id="kpiAreaDay">–</span></div>
          <div class="kpi"><span class="label">Terület Δ (hét):</span> <span class="val" id="kpiAreaWeek">–</span></div>
          <div class="kpi"><span class="label">FIRMS Δ (nap):</span> <span class="val" id="kpiFirmsDay">–</span></div>
          <div class="kpi"><span class="label">FIRMS össz (7 nap):</span> <span class="val" id="kpiFirmsWeek">–</span></div>
        </div>
        <div class="muted" style="margin-top:6px;">A terület közelítő számítás (EPSG:3857), trendkövetésre jó.</div>
      </div>

      <div id="log" class="log">Indul…</div>
    </div>
  </div>

  <!-- RIGHT -->
  <div id="rightPanel" class="panel rightPanel">
    <div class="head">
      <div>
        <h3>Idősáv</h3>
        <div class="muted">Kattints a térképre “Kattintásra” módban: oda zoomol.</div>
      </div>
      <button id="rightToggleBtn" class="btnIcon" type="button" title="Összecsuk/kinyit">☰</button>
    </div>
    <div class="body">
      <div class="row">
        <span class="chip">Dátum: <b id="dateLabel">…</b></span>
        <span class="chip">Fájl: <span id="fileLabel">…</span></span>
      </div>

      <div class="row">
        <span class="chip">Lejátszás:
          <select id="speedSel">
            <option value="300" selected>0.3s</option>
            <option value="600">0.6s</option>
            <option value="1200">1.2s</option>
            <option value="2000">2.0s</option>
          </select>
        </span>
      </div>

      <div class="slider-wrap">
        <button id="playBtn" class="btn" type="button" disabled>Lejátszás</button>
        <input id="daySlider" type="range" min="0" max="0" value="0" step="1" disabled />
      </div>
    </div>
  </div>

  <div class="legend">
    <b>Jelmagyarázat</b>
    <div class="item"><span class="swatch" style="background:#6b0000;"></span>DeepState terület (kitöltés)</div>
    <div class="item"><span class="swatch" style="background:#d00;"></span>DeepState határ/frontvonal</div>
    <div class="item"><span class="swatch" style="background:#ff5500;"></span>FIRMS hőpont (kattintás: lat/lon + település lekérdezés)</div>
    <div class="item"><span class="swatch" style="background:#2b6cff;"></span>UA csapat jelölő</div>
    <div class="item"><span class="swatch" style="background:#000;"></span>RU csapat jelölő</div>
  </div>

<script>
(() => {
  // =========================
  // Konfig
  // =========================
  const FIRMS_MAP_KEY = "44b266fd8324db5a0a9866017429dc43"; // <-- a saját kulcsod idézőjelekkel!
  const UKRAINE_BBOX = "22,44,40,53";
  const UKRAINE_BOUNDS_RAW = { sw: [44.0, 22.0], ne: [52.7, 40.2] }; // lat,lon (L nélkül)

  // =========================
  // UI refs
  // =========================
  const leftPanel = document.getElementById("leftPanel");
  const rightPanel = document.getElementById("rightPanel");
  const leftToggleBtn = document.getElementById("leftToggleBtn");
  const rightToggleBtn = document.getElementById("rightToggleBtn");

  const logEl = document.getElementById("log");
  const dateLabel = document.getElementById("dateLabel");
  const fileLabel = document.getElementById("fileLabel");
  const slider = document.getElementById("daySlider");
  const playBtn = document.getElementById("playBtn");
  const zoomBtn = document.getElementById("zoomBtn");

  const toggleDeep = document.getElementById("toggleDeep");
  const toggleFirms = document.getElementById("toggleFirms");
  const toggleGibs = document.getElementById("toggleGibs");
  const toggleTroops = document.getElementById("toggleTroops");
  const toggleLog = document.getElementById("toggleLog");

  const baseSel = document.getElementById("baseSel");
  const firmsDaysSel = document.getElementById("firmsDaysSel");
  const maxPtsSel = document.getElementById("maxPtsSel");
  const speedSel = document.getElementById("speedSel");
  const keyStatus = document.getElementById("keyStatus");
  const zoomSel = document.getElementById("zoomSel");
  const reloadTroopsBtn = document.getElementById("reloadTroopsBtn");

  const gibsSel = document.getElementById("gibsSel");
  const gibsOpacity = document.getElementById("gibsOpacity");

  const kpiAreaDay = document.getElementById("kpiAreaDay");
  const kpiAreaWeek = document.getElementById("kpiAreaWeek");
  const kpiFirmsDay = document.getElementById("kpiFirmsDay");
  const kpiFirmsWeek = document.getElementById("kpiFirmsWeek");

  function log(msg){ logEl.textContent += "\n" + msg; }
  function setText(el, v){ el.textContent = v; }

  // Panel collapse / mobile friendliness
  function setCollapsed(panelEl, collapsed){
    panelEl.classList.toggle("collapsed", collapsed);
  }
  function isMobile(){ return window.matchMedia && window.matchMedia("(max-width: 820px)").matches; }

  // default mobile: collapsed
  setCollapsed(leftPanel, isMobile());
  setCollapsed(rightPanel, isMobile());

  leftToggleBtn.addEventListener("click", () => setCollapsed(leftPanel, !leftPanel.classList.contains("collapsed")));
  rightToggleBtn.addEventListener("click", () => setCollapsed(rightPanel, !rightPanel.classList.contains("collapsed")));

  window.addEventListener("resize", () => {
    // if switching to mobile, collapse both; if back to desktop, open both
    if(isMobile()){
      setCollapsed(leftPanel, true);
      setCollapsed(rightPanel, true);
    }else{
      setCollapsed(leftPanel, false);
      setCollapsed(rightPanel, false);
    }
  });

  // Global error logging
  window.addEventListener("error", (e) => log("JS ERROR: " + (e.message || e.error || e)));
  window.addEventListener("unhandledrejection", (e) => log("PROMISE ERROR: " + (e.reason || e)));

  if (!window.L) {
    log("HIBA: Leaflet (L) nem töltött be. CDN gond lehet.");
    keyStatus.textContent = "FIRMS kulcs: (Leaflet hiba)";
    return;
  }

  // =========================
  // Map init
  // =========================
  const map = L.map("map", { zoomControl: true }).setView([49.0, 31.0], 6);

  const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  const esriSat = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
    maxZoom: 19,
    attribution: "Tiles &copy; Esri"
  });

  baseSel.addEventListener("change", () => {
    const v = baseSel.value;
    if (v === "sat") { map.removeLayer(osm); esriSat.addTo(map); }
    else { map.removeLayer(esriSat); osm.addTo(map); }
  });

  const UKRAINE_BOUNDS = L.latLngBounds(
    L.latLng(UKRAINE_BOUNDS_RAW.sw[0], UKRAINE_BOUNDS_RAW.sw[1]),
    L.latLng(UKRAINE_BOUNDS_RAW.ne[0], UKRAINE_BOUNDS_RAW.ne[1])
  );

  // =========================
  // Layers
  // =========================
  let deepStateLayer = null;
  let gibsLayer = null;

  const firmsLayer = L.layerGroup().addTo(map);
  let firmsByDate = {}; // { "YYYY-MM-DD": [pt,pt...] }

  const troopsLayer = L.layerGroup().addTo(map);

  function setVisible(layer, on){
    if(!layer) return;
    if(on) layer.addTo(map);
    else if(map.hasLayer(layer)) map.removeLayer(layer);
  }

  toggleDeep.addEventListener("change", () => setVisible(deepStateLayer, toggleDeep.checked));
  toggleFirms.addEventListener("change", () => setVisible(firmsLayer, toggleFirms.checked));
  toggleTroops.addEventListener("change", () => setVisible(troopsLayer, toggleTroops.checked));

  toggleLog.addEventListener("change", () => logEl.classList.toggle("hidden", !toggleLog.checked));

  // =========================
  // GIBS overlay (NASA heatmap)
  // =========================
  function gibsTemplateFor(sel){
    // Date format must be YYYY-MM-DD
    if(sel === "modis1k"){
      return "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_Thermal_Anomalies_All/default/{date}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png";
    }
    // default: VIIRS SNPP 375m
    return "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_Thermal_Anomalies_375m_All/default/{date}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png";
  }

  function setGibs(dateStr){
    const tpl = gibsTemplateFor(gibsSel.value);
    const url = tpl.replace("{date}", dateStr);

    const op = Number(gibsOpacity.value || "0.55");
    if (!gibsLayer) {
      gibsLayer = L.tileLayer(url, {
        opacity: op,
        maxZoom: 19,
        maxNativeZoom: 9,
        attribution: "NASA GIBS"
      });
    } else {
      gibsLayer.setUrl(url);
      gibsLayer.setOpacity(op);
    }
    setVisible(gibsLayer, toggleGibs.checked);
  }

  toggleGibs.addEventListener("change", () => { if(currentDate) setGibs(currentDate); });
  gibsSel.addEventListener("change", () => { if(currentDate) setGibs(currentDate); });
  gibsOpacity.addEventListener("input", () => { if(gibsLayer) gibsLayer.setOpacity(Number(gibsOpacity.value || "0.55")); });

  // =========================
  // Zoom
  // =========================
  let clickZoomEnabled = false;
  zoomSel.addEventListener("change", () => { clickZoomEnabled = (zoomSel.value === "click"); });

  map.on("click", (e) => {
    if(!clickZoomEnabled) return;
    map.setView(e.latlng, Math.max(map.getZoom(), 10), { animate: true });
  });

  function doZoom(){
    const mode = zoomSel.value;
    if(mode === "front" && deepStateLayer){
      const b = deepStateLayer.getBounds();
      if(b && b.isValid && b.isValid()) map.fitBounds(b.pad(0.12));
      return;
    }
    if(mode === "ukr"){
      map.fitBounds(UKRAINE_BOUNDS.pad(0.08));
    }
  }
  zoomBtn.addEventListener("click", doZoom);

  // =========================
  // Fetch helpers
  // =========================
  async function loadJson(url){
    const r = await fetch(url, { cache: "no-store" });
    if(!r.ok) throw new Error(`Fetch hiba: ${url} → HTTP ${r.status}`);
    return await r.json();
  }

  // =========================
  // DeepState rendering + area calculation
  // =========================
  function renderDeepState(data){
    if(deepStateLayer) map.removeLayer(deepStateLayer);
    deepStateLayer = L.geoJSON(data, {
      style: () => ({ color:"#d00", weight:2.2, opacity:0.95, fillColor:"#6b0000", fillOpacity:0.28 })
    });
    setVisible(deepStateLayer, toggleDeep.checked);
  }

  // Project lon/lat to meters (EPSG3857) and compute polygon area (shoelace), with holes handling.
  function ringAreaMeters2(ringLonLat){
    // ringLonLat: [[lon,lat], ...]
    if(!ringLonLat || ringLonLat.length < 4) return 0;
    let area = 0;
    for(let i=0; i<ringLonLat.length-1; i++){
      const a = ringLonLat[i], b = ringLonLat[i+1];
      const pa = L.CRS.EPSG3857.project(L.latLng(a[1], a[0]));
      const pb = L.CRS.EPSG3857.project(L.latLng(b[1], b[0]));
      area += (pa.x * pb.y - pb.x * pa.y);
    }
    return area / 2; // signed
  }

  function geomAreaMeters2(geom){
    if(!geom) return 0;
    const t = geom.type;
    const coords = geom.coordinates;
    let total = 0;

    if(t === "Polygon"){
      // coords: [outerRing, hole1, hole2...]
      if(coords.length === 0) return 0;
      const outer = Math.abs(ringAreaMeters2(coords[0]));
      let holes = 0;
      for(let i=1; i<coords.length; i++) holes += Math.abs(ringAreaMeters2(coords[i]));
      total += Math.max(0, outer - holes);
      return total;
    }

    if(t === "MultiPolygon"){
      // coords: [ polygon, polygon, ... ] each polygon as above
      for(const poly of coords){
        if(!poly || poly.length === 0) continue;
        const outer = Math.abs(ringAreaMeters2(poly[0]));
        let holes = 0;
        for(let i=1; i<poly.length; i++) holes += Math.abs(ringAreaMeters2(poly[i]));
        total += Math.max(0, outer - holes);
      }
      return total;
    }

    return 0;
  }

  function featureCollectionAreaKm2(fc){
    if(!fc || !Array.isArray(fc.features)) return 0;
    let m2 = 0;
    for(const f of fc.features){
      if(!f || !f.geometry) continue;
      m2 += geomAreaMeters2(f.geometry);
    }
    return m2 / 1e6;
  }

  // =========================
  // FIRMS
  // =========================
  function parseCSV(csvText){
    const lines = csvText.split(/\r?\n/).filter(Boolean);
    if(lines.length <= 1) return [];
    const header = lines[0].split(",");
    const idx = (name) => header.indexOf(name);

    const iLat = idx("latitude"), iLon = idx("longitude"), iDate = idx("acq_date"), iTime = idx("acq_time");
    const iBright = idx("brightness"), iSat = idx("satellite"), iConf = idx("confidence"), iFRP = idx("frp"), iDN = idx("daynight");

    const out = [];
    for(let k=1; k<lines.length; k++){
      const c = lines[k].split(",");
      if(c.length < header.length) continue;
      const lat = parseFloat(c[iLat]), lon = parseFloat(c[iLon]);
      if(!Number.isFinite(lat) || !Number.isFinite(lon)) continue;

      out.push({
        lat, lon,
        acq_date: c[iDate] ?? "",
        acq_time: c[iTime] ?? "",
        bright: c[iBright] ?? "",
        frp: c[iFRP] ?? "",
        sat: c[iSat] ?? "",
        conf: c[iConf] ?? "",
        daynight: c[iDN] ?? ""
      });
    }
    return out;
  }

  async function fetchFIRMSCache(){
    firmsByDate = {};
    firmsLayer.clearLayers();

    const keyOk = (FIRMS_MAP_KEY && FIRMS_MAP_KEY !== "IDE_IRD_BE_A_KULCSOT" && FIRMS_MAP_KEY.length >= 10);
    if(!keyOk){
      keyStatus.textContent = "FIRMS kulcs: NINCS";
      log("FIRMS: nincs beállítva a MAP_KEY (index.html-ben).");
      return;
    }
    keyStatus.textContent = "FIRMS kulcs: OK (" + FIRMS_MAP_KEY.slice(0,4) + "…)";

    const days = Number(firmsDaysSel.value) || 10;
    const products = ["VIIRS_SNPP_NRT", "VIIRS_NOAA20_NRT"];

    let total = 0;
    for(const prod of products){
      const url = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/${encodeURIComponent(FIRMS_MAP_KEY)}/${prod}/${UKRAINE_BBOX}/${days}`;
      log(`FIRMS fetch: ${prod} | last ${days} days`);
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok){ log(`FIRMS HTTP hiba (${prod}): ${r.status}`); continue; }
      const txt = await r.text();
      const pts = parseCSV(txt);
      total += pts.length;

      for(const p of pts){
        if(!p.acq_date) continue;
        if(!firmsByDate[p.acq_date]) firmsByDate[p.acq_date] = [];
        firmsByDate[p.acq_date].push(p);
      }
    }

    const ds = Object.keys(firmsByDate).sort();
    log(`FIRMS pontok összesen: ${total}`);
    log(`FIRMS napok: ${ds.length} (${ds[0] || "-"} .. ${ds[ds.length-1] || "-"})`);

    if(currentDate) renderFIRMSForDate(currentDate);
  }

  function fmtTime(acq){
    const timeStr = (acq || "").toString().padStart(4, "0");
    return timeStr.length === 4 ? (timeStr.slice(0,2) + ":" + timeStr.slice(2,4)) : timeStr;
  }

  // Reverse geocode on demand (button click in popup)
  window.lookupPlace = async function(lat, lon, elId){
    const el = document.getElementById(elId);
    if(!el) return;
    el.textContent = "Település: betöltés…";

    // Nominatim rate limit-friendly: only on click.
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&zoom=12&addressdetails=1`;
    try{
      const r = await fetch(url, { cache: "no-store" });
      if(!r.ok) throw new Error("HTTP " + r.status);
      const j = await r.json();
      const name = j?.name || j?.display_name || "Nincs találat";
      el.textContent = "Település: " + name;
    }catch(e){
      el.textContent = "Település: hiba (" + String(e) + ")";
    }
  };

  function renderFIRMSForDate(dateStr){
    firmsLayer.clearLayers();
    if(!toggleFirms.checked) return;

    const pts = firmsByDate[dateStr] || [];
    const maxPts = Number(maxPtsSel.value) || 1500;

    if(pts.length === 0){
      log(`FIRMS: 0 pont erre a napra: ${dateStr}`);
      return;
    }

    const use = (pts.length > maxPts) ? pts.slice(0, maxPts) : pts;

    for(let idx=0; idx<use.length; idx++){
      const p = use[idx];
      const frp = Number(p.frp);
      const radius = Number.isFinite(frp) ? Math.max(3, Math.min(9, 2 + frp/20)) : 4;

      const placeElId = `place_${dateStr.replaceAll("-","")}_${idx}_${Math.floor(Math.random()*1e6)}`;

      const popupHtml =
        `<b>FIRMS hőpont</b><br>` +
        `Dátum: ${p.acq_date}<br>` +
        `Idő (UTC): ${fmtTime(p.acq_time)}<br>` +
        `Lat/Lon: ${p.lat.toFixed(5)}, ${p.lon.toFixed(5)}<br>` +
        `FRP: ${p.frp || "-"} | Conf: ${p.conf || "-"} | Sat: ${p.sat || "-"}<br>` +
        `<div id="${placeElId}" style="margin-top:6px;">Település: –</div>` +
        `<button style="margin-top:6px;border:0;border-radius:10px;padding:7px 10px;background:#111;color:#fff;cursor:pointer;font-size:12px;" ` +
        `onclick="lookupPlace(${p.lat},${p.lon},'${placeElId}')">Település betöltése</button>`;

      firmsLayer.addLayer(
        L.circleMarker([p.lat, p.lon], { radius, color:"#ff5500", weight:1, opacity:0.9, fillOpacity:0.65 })
          .bindPopup(popupHtml)
      );
    }

    log(`FIRMS: ${use.length}/${pts.length} pont kirajzolva (${dateStr})`);
  }

  // =========================
  // Troops (manual GeoJSON)
  // =========================
  async function loadTroops(){
    troopsLayer.clearLayers();
    try{
      const gj = await loadJson("./data/troops.geojson");
      const layer = L.geoJSON(gj, {
        pointToLayer: (f, latlng) => {
          const side = (f.properties?.side ?? "unknown").toString().toLowerCase();
          const color = side === "ua" ? "#2b6cff" : (side === "ru" ? "#000" : "#666");
          const label = f.properties?.label ?? "Ismeretlen";
          return L.circleMarker(latlng, { radius: 7, color, weight: 2, fillOpacity: 0.65 }).bindPopup(label);
        }
      });
      troopsLayer.addLayer(layer);
      setVisible(troopsLayer, toggleTroops.checked);
      log("Troops: betöltve ✔ (data/troops.geojson)");
    }catch(e){
      log("Troops: NINCS data/troops.geojson → ezért nem látszik semmi.");
    }
  }
  reloadTroopsBtn.addEventListener("click", loadTroops);

  // =========================
  // Timeline + play
  // =========================
  let dates = []; // [{date,name,raw}]
  let currentDate = null;

  let playing = false;
  let timer = null;

  function stopPlay(){
    playing = false;
    playBtn.textContent = "Lejátszás";
    if(timer){ clearInterval(timer); timer = null; }
  }
  function stepOnce(){
    let v = Number(slider.value);
    if(v >= Number(slider.max)) v = Number(slider.min);
    else v += 1;
    slider.value = String(v);
    loadByIndex(v, false);
  }
  function startPlay(){
    playing = true;
    playBtn.textContent = "Megállítás";
    const ms = Number(speedSel.value) || 300;
    timer = setInterval(stepOnce, ms);
  }

  playBtn.addEventListener("click", () => {
    if(playing) stopPlay();
    else startPlay();
  });

  speedSel.addEventListener("change", () => { if(playing){ stopPlay(); startPlay(); } });

  firmsDaysSel.addEventListener("change", async () => {
    await fetchFIRMSCache();
    updateSummaryForIndex(Number(slider.value));
  });

  maxPtsSel.addEventListener("change", () => { if(currentDate) renderFIRMSForDate(currentDate); });

  // =========================
  // Summary (daily & weekly)
  // =========================
  const deepStateAreaCache = new Map(); // rawUrl -> areaKm2

  function fmtDeltaKm2(d){
    if(d === null || d === undefined || !Number.isFinite(d)) return "n/a";
    const sign = d > 0 ? "+" : (d < 0 ? "−" : "±");
    const val = Math.abs(d);
    if(val >= 1000) return `${sign}${val.toFixed(0)} km²`;
    if(val >= 100) return `${sign}${val.toFixed(1)} km²`;
    return `${sign}${val.toFixed(2)} km²`;
  }
  function fmtDeltaCount(d){
    if(d === null || d === undefined || !Number.isFinite(d)) return "n/a";
    const sign = d > 0 ? "+" : (d < 0 ? "−" : "±");
    return `${sign}${Math.abs(d)}`;
  }

  async function getDeepStateAreaKm2ByIndex(i){
    const item = dates[i];
    if(!item) return null;
    if(deepStateAreaCache.has(item.raw)) return deepStateAreaCache.get(item.raw);

    try{
      const data = await loadJson(item.raw);
      const km2 = featureCollectionAreaKm2(data);
      deepStateAreaCache.set(item.raw, km2);
      return km2;
    }catch(e){
      return null;
    }
  }

  function firmsCountForDate(dateStr){
    const pts = firmsByDate[dateStr] || null;
    return pts ? pts.length : null;
  }

  function firmsSumForLastNDatesFromIndex(i, n){
    // sum only if firmsByDate has those dates; if not available => null
    let sum = 0;
    let any = false;
    for(let k=0; k<n; k++){
      const j = i - k;
      if(j < 0) break;
      const d = dates[j]?.date;
      if(!d) continue;
      const c = firmsCountForDate(d);
      if(c === null) continue;
      sum += c;
      any = true;
    }
    return any ? sum : null;
  }

  async function updateSummaryForIndex(i){
    // DeepState deltas
    const areaNow = await getDeepStateAreaKm2ByIndex(i);
    const areaPrev = await getDeepStateAreaKm2ByIndex(i-1);
    const areaWeek = await getDeepStateAreaKm2ByIndex(i-7);

    const dDay = (areaNow !== null && areaPrev !== null) ? (areaNow - areaPrev) : null;
    const dWeek = (areaNow !== null && areaWeek !== null) ? (areaNow - areaWeek) : null;

    kpiAreaDay.textContent = fmtDeltaKm2(dDay);
    kpiAreaWeek.textContent = fmtDeltaKm2(dWeek);

    // FIRMS deltas (only for recent days within FIRMS API window)
    const dateNow = dates[i]?.date;
    const datePrev = dates[i-1]?.date;

    const cNow = dateNow ? firmsCountForDate(dateNow) : null;
    const cPrev = datePrev ? firmsCountForDate(datePrev) : null;

    const fdDay = (cNow !== null && cPrev !== null) ? (cNow - cPrev) : null;
    const sum7 = firmsSumForLastNDatesFromIndex(i, 7);

    kpiFirmsDay.textContent = (fdDay === null) ? "n/a" : fmtDeltaCount(fdDay);
    kpiFirmsWeek.textContent = (sum7 === null) ? "n/a" : String(sum7);
  }

  // =========================
  // Load by index
  // =========================
  async function loadByIndex(i, doZoomNow=true){
    const item = dates[i];
    if(!item) return;

    currentDate = item.date;
    setText(dateLabel, item.date);
    setText(fileLabel, item.name);

    const data = await loadJson(item.raw);
    renderDeepState(data);

    // Keep GIBS synced to selected date if enabled
    setGibs(item.date);

    // FIRMS points for selected day
    renderFIRMSForDate(item.date);

    // Summary update
    updateSummaryForIndex(i);

    if(doZoomNow) doZoom();
  }

  // =========================
  // Init
  // =========================
  async function init(){
    log("Leaflet OK. Térkép indul…");

    try{
      dates = await loadJson("./data/deepstate_dates.json");
      if(!Array.isArray(dates) || dates.length === 0) throw new Error("Üres deepstate_dates.json");

      slider.min = "0";
      slider.max = String(dates.length - 1);
      slider.value = String(dates.length - 1);
      slider.disabled = false;

      slider.addEventListener("input", () => { stopPlay(); loadByIndex(Number(slider.value), false); });

      // Initial day
      await loadByIndex(dates.length - 1, true);

      // FIRMS (async cache)
      await fetchFIRMSCache();

      // Troops (optional file)
      await loadTroops();

      playBtn.disabled = false;
      log("Kész ✔");

      // If user enables GIBS, it is already synced (setGibs called in loadByIndex)
      setVisible(gibsLayer, toggleGibs.checked);
    }catch(e){
      log("INIT HIBA: " + String(e));
    }
  }

  // Layer toggles that depend on currentDate / gibsLayer existence
  toggleGibs.addEventListener("change", () => {
    if(!currentDate) return;
    setGibs(currentDate);
  });

  init();
})();
</script>
</body>
</html>
