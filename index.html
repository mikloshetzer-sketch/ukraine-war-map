<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ukrajna h√°bor√∫s t√©rk√©p ‚Äì DeepState</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{height:100%;margin:0}
#map{height:100%;width:100%;background:#fff}

/* PANELS */
.panel{
 position:absolute;
 z-index:1000;
 background:rgba(255,255,255,.95);
 border-radius:12px;
 box-shadow:0 6px 18px rgba(0,0,0,.2);
 font:13px system-ui;
 max-width:560px;
 overflow:hidden;
}

.panel .head{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:10px 12px;
 background:#fff;
}

.panel .body{padding:10px 12px}
.panel .toggleBtn{background:#111;color:#fff;border:0;border-radius:10px;padding:8px 10px}

#panelLeft{top:12px;left:12px}
#panelRight{top:12px;right:12px}

.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}

.chip{background:#f2f2f2;padding:7px 10px;border-radius:999px}
.btn{background:#111;color:#fff;border:0;border-radius:10px;padding:8px 12px}

#legend{
 position:absolute;
 bottom:12px;
 left:12px;
 z-index:1000;
 background:rgba(255,255,255,.95);
 border-radius:12px;
 padding:10px;
 box-shadow:0 6px 18px rgba(0,0,0,.2);
 font-size:12px;
}

/* MOBILE FIX */
@media (max-width:820px){

 .panel{
  left:8px!important;
  right:8px!important;
  max-width:none!important;
 }

 #panelLeft{top:8px!important}

 #panelRight{
  top:auto!important;
  bottom:90px!important;
 }

 #legend{
  left:8px!important;
  right:8px!important;
  bottom:8px!important;
 }

}
</style>
</head>

<body>
<div id="map"></div>

<div id="panelLeft" class="panel">
 <div class="head">
  <b>R√©tegek</b>
 </div>
 <div class="body">

  <div class="row">
   <label class="chip"><input id="chkDeep" type="checkbox" checked> DeepState</label>
   <label class="chip"><input id="chkFirms" type="checkbox" checked> FIRMS</label>
   <label class="chip"><input id="chkGibs" type="checkbox"> NASA h≈ët√©rk√©p</label>
  </div>

  <div id="latestNotice" style="margin-top:10px;color:#a00;font-size:12px"></div>

  <div class="row">
   <button id="btnRefresh" class="btn">üîÑ Adat friss√≠t√©s</button>
  </div>

 </div>
</div>

<div id="panelRight" class="panel">
 <div class="head">
  <b>Id≈ës√°v</b>
 </div>
 <div class="body">

  <div class="row">
   <span id="lblDate">‚Ä¶</span>
  </div>

  <div class="row">
   <button id="btnPlay" class="btn">Lej√°tsz√°s</button>
  </div>

  <input id="rngDay" type="range" min="0" max="0" value="0" style="width:100%">

  <div class="row">
   <select id="jumpSelect"></select>
  </div>

 </div>
</div>

<div id="legend">
 <b>Jelmagyar√°zat</b><br>
 <span style="color:#6b0000">‚ñ†</span> Megsz√°llt ter√ºlet<br>
 <span style="color:#ff5500">‚ñ†</span> FIRMS h≈ëpont
</div>

<script>

const map=L.map("map").setView([49,31],6)

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map)

let deepLayer=null
let dates=[]
let currentDate=null

async function loadDates(){
 const r=await fetch("./data/deepstate_dates.json",{cache:"no-store"})
 dates=await r.json()

 document.getElementById("rngDay").max=dates.length-1
 document.getElementById("rngDay").value=dates.length-1

 buildJumpList()
 checkLatestDate()

 loadByIndex(dates.length-1)
}

function checkLatestDate(){
 const latest=dates[dates.length-1].date
 const today=new Date().toISOString().slice(0,10)

 if(latest!==today){
  document.getElementById("latestNotice").textContent=
   "Nincs mai DeepState f√°jl. Legut√≥bbi: "+latest
 }
}

function buildJumpList(){
 const sel=document.getElementById("jumpSelect")
 sel.innerHTML=""

 const add=(txt,idx)=>{
  const o=document.createElement("option")
  o.textContent=txt
  o.value=idx
  sel.appendChild(o)
 }

 add("Legfrissebb",dates.length-1)
 add("‚àí7 nap",Math.max(0,dates.length-7))
 add("‚àí30 nap",Math.max(0,dates.length-30))
 add("‚àí180 nap",Math.max(0,dates.length-180))
 add("‚àí365 nap",Math.max(0,dates.length-365))

 sel.onchange=()=>loadByIndex(sel.value)
}

async function loadByIndex(i){
 const d=dates[i]
 currentDate=d.date
 document.getElementById("lblDate").textContent=d.date

 const r=await fetch(d.raw,{cache:"no-store"})
 const data=await r.json()

 if(deepLayer)map.removeLayer(deepLayer)

 deepLayer=L.geoJSON(data,{
  style:{color:"#d00",fillColor:"#6b0000",fillOpacity:.3}
 }).addTo(map)
}

document.getElementById("rngDay").oninput=e=>loadByIndex(e.target.value)

document.getElementById("btnRefresh").onclick=()=>location.reload()

let playing=false
let timer=null

document.getElementById("btnPlay").onclick=()=>{
 if(!playing){
  playing=true
  timer=setInterval(()=>{
   let v=Number(document.getElementById("rngDay").value)
   if(v<dates.length-1)v++
   document.getElementById("rngDay").value=v
   loadByIndex(v)
  },400)
 }else{
  playing=false
  clearInterval(timer)
 }
}

loadDates()

</script>
</body>
</html>
